---
last_mapped: 2026-02-21T23:10:00Z
total_files: 10
total_tokens: 12924
---

# Codebase Map

> Auto-generated by Cartographer. Last mapped: 2026-02-21.

## System Overview

Cadence is a macOS-native Pomodoro timer built with Swift 6 and SwiftUI. It runs as a floating desktop window with a menu bar icon, implementing the standard Pomodoro cycle: 25-minute focus sessions with 5-minute short breaks and a 15-minute long break after every 4 focus sessions. The app is intentionally minimal — no configuration, no persistence, no integrations. Built with Swift Package Manager, distributed as an ad-hoc signed `.app` bundle.

## Architecture

```
┌─────────────────────────────────────────────────┐
│                  CadenceApp                      │
│                  (@main entry)                   │
│                                                  │
│  AppDelegate                                     │
│  ├── TimerState (@Observable, core logic)        │
│  ├── WindowManager (floating NSWindow)           │
│  ├── NotificationManager (UNUserNotification)    │
│  └── NSStatusItem (menu bar icon)                │
│                                                  │
│  TimerView (SwiftUI)                             │
│  ├── PhaseBackground (radial gradient)           │
│  ├── PhaseHeader (phase name + subtitle)         │
│  ├── CircularTimerView (progress ring + time)    │
│  ├── SessionProgressDots (4 dots)                │
│  └── ControlButton (start/pause, Space key)      │
│                                                  │
│  MenuBarIconImage (NSImage, 6 visual states)     │
└─────────────────────────────────────────────────┘
```

Data flow is unidirectional: `TimerState` is the single source of truth. `TimerView` observes it via `@Observable`/`@Bindable`. `AppDelegate` polls it (0.5s) for status bar icon updates.

## Directory Structure

```
cadence/
├── Sources/CadenceApp/         # All application code (5 files)
│   ├── CadenceApp.swift        # @main, AppDelegate, MenuBarIconImage
│   ├── TimerState.swift        # Core timer logic, phase machine
│   ├── TimerView.swift         # Full SwiftUI view hierarchy
│   ├── WindowManager.swift     # Floating NSWindow management
│   └── NotificationManager.swift # System notifications + sounds
├── Tests/CadenceTests/
│   └── TimerStateTests.swift   # 14 tests covering timer logic
├── scripts/
│   ├── bundle.sh               # Release build + .app bundle creation
│   └── dev.sh                  # Debug build + launch
├── .github/workflows/
│   └── cerberus.yml            # AI code review (5 perspectives)
├── Package.swift               # Swift 6.0, macOS 14+
├── spec.md                     # Product specification
└── README.md                   # Install + usage
```

## Module Guide

### TimerState (`Sources/CadenceApp/TimerState.swift`)

**Purpose**: Core state machine. Manages phases, countdown, session tracking.

**Key API**:
- `start()`, `pause()`, `toggle()`, `reset()` — lifecycle
- `tick(notificationManager:)` — called every 1s by Timer
- `advancePhase(notificationManager:)` — state transitions
- `skipPhase(notificationManager:)` — DEBUG only

**State**: `currentPhase`, `secondsRemaining`, `isRunning`, `completedFocusSessions`

**Computed**: `progress` (0.0–1.0), `displayCompletedSessions` (shows 4 during long break)

**Phase enum**: `.focus`, `.shortBreak`, `.longBreak` — each carries `name`, `duration`, `color`, `nsColor`, `sfSymbol`, `notificationBody`, `systemSound`, `isFocus`.

### CadenceApp (`Sources/CadenceApp/CadenceApp.swift`)

**Purpose**: App entry point + menu bar icon rendering.

**AppDelegate**: Sets `.accessory` activation policy (no dock icon). Creates `WindowManager`, `NotificationManager`, `TimerState`. Sets up `NSStatusItem` with left-click (toggle window) and right-click (context menu: Show Timer, Quit).

**MenuBarIconImage**: Renders 6 distinct NSImage states based on (phase, isRunning) — filled circle, stroked circle, half-filled, dashed, etc. Uses `NSBezierPath` drawing, marked as template image.

**Status bar polling**: 0.5s `Timer.scheduledTimer` checks phase/running changes. Not using `withObservationTracking` (comment says "more reliable").

### TimerView (`Sources/CadenceApp/TimerView.swift`)

**Purpose**: Complete SwiftUI view hierarchy.

**Components**: `PhaseBackground` (radial gradient, dark/light aware), `PhaseHeader` (phase name + subtitle), `CircularTimerView` (240x240 progress ring with glow), `SessionProgressDots` (4 animated dots), `ControlButton` (capsule button, Space shortcut).

**Fixed size**: 380x480 points.

**Custom modifier**: `PressEventsModifier` for button press/release animations via `DragGesture(minimumDistance: 0)`.

### WindowManager (`Sources/CadenceApp/WindowManager.swift`)

**Purpose**: Creates and manages the floating NSWindow.

**Window config**: `.floating` level, `.canJoinAllSpaces`, transparent titlebar, hidden zoom/miniaturize buttons, movable by background. Uses `setFrameAutosaveName` for position persistence. Validates restored frame is on-screen.

**Close behavior**: Hides instead of closing (`windowShouldClose` returns false).

### NotificationManager (`Sources/CadenceApp/NotificationManager.swift`)

**Purpose**: System notifications and sounds on phase transitions.

**Behavior**: Requests authorization on launch (if `.notDetermined`). On notify: plays `NSSound` (Ping/Glass/Hero per phase) AND sends `UNNotificationRequest`. Guards against nil `bundleIdentifier` (SPM debug builds).

## Conventions

- **Swift 6** strict concurrency: all mutable state is `@MainActor`
- **No third-party dependencies**: zero `dependencies` in Package.swift
- **SwiftUI Observation framework**: `@Observable` (not `ObservableObject`)
- **Testing**: Swift Testing framework (`@Test`, `#expect`), not XCTest
- **Bundle ID**: `com.mistystep.cadence` (release), `dev.mistystep.cadence.debug` (dev)
- **Hardcoded values**: Timer durations are intentionally non-configurable

## Gotchas

1. **Timer creates new NotificationManager each tick**: `startBackgroundTimer()` passes `NotificationManager()` to `tick()` instead of the app's shared instance. Notifications still work (stateless), but wasteful object creation every second.

2. **Status bar uses polling, not observation**: Despite `@Observable`, the status bar icon updates via a 0.5s polling timer rather than `withObservationTracking`. Comment says "more reliable."

3. **SPM executable, not Xcode project**: Build via `swift build` or `scripts/bundle.sh`, not Xcode. The `.app` bundle is constructed manually with embedded `Info.plist` via linker flags (`-sectcreate __TEXT __info_plist`).

4. **LSUIElement = true**: App has no dock icon. Only visible via menu bar and floating window.

5. **Ad-hoc code signing**: No developer certificate. Uses `codesign --sign -` which limits distribution (no notarization, no App Store).

6. **`Cadence.app` is gitignored**: The built bundle is a build artifact, not checked in (despite appearing in the repo root after building).

## Navigation Guide

**To modify timer durations**: `Sources/CadenceApp/TimerState.swift` → `Phase.duration`
**To change visual design**: `Sources/CadenceApp/TimerView.swift` → component structs
**To modify window behavior**: `Sources/CadenceApp/WindowManager.swift` → `createWindow()`
**To change menu bar icon**: `Sources/CadenceApp/CadenceApp.swift` → `MenuBarIconImage`
**To adjust notifications**: `Sources/CadenceApp/NotificationManager.swift`
**To add/modify tests**: `Tests/CadenceTests/TimerStateTests.swift`
**To change build/bundle**: `scripts/bundle.sh`
